<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleafe/layout"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>프로젝트 관리</title>
    <style>
        /* 기존 스타일 유지 */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .breadcrumb {
            background: #f7fafc;
            color: #718096;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .breadcrumb a {
            color: #e4b6ec;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .page-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
            color: #2d3748;
        }

        .project-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            color: #e4b6ec;
            border-bottom-color: #e4b6ec;
        }

        .tab:hover {
            color: #e4b6ec;
        }

        .tab-count {
            background: #e4b6ec;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: bold;
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
            min-height: 400px;
        }

        .project-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            height: 180px;

        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(228, 182, 236, 0.15);
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #e4b6ec, #d196dd);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .project-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
            line-height: 1.4;
            flex: 1;
        }

        .project-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #e6fffa;
            color: #00a085;
        }

        .status-planning {
            background: #e6f3ff;
            color: #0080ff;
        }

        .status-completed {
            background: #f0f4f8;
            color: #718096;
        }

        .status-expired {
            background: #ffe6e6;
            color: #e60000;
        }

        .project-info {
            margin-bottom: 20px;
        }

        .project-date {
            color: #718096;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .project-description {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.5;
        }

        .stats-bar {
            display: flex;
            gap: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: #f7fafc;
        }

        .stat-item.active {
            background: #f3e8ff;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #e4b6ec;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
            margin-top: 5px;
        }

        .search-bar {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            padding: 12px 20px;
            width: 300px;
            font-size: 14px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .search-bar:focus {
            outline: none;
            border-color: #e4b6ec;
            box-shadow: 0 0 0 3px rgba(228, 182, 236, 0.1);
        }

        .no-projects {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
            font-size: 16px;
            grid-column: 1 / -1;
        }

        /* 페이징 스타일 */
        #pagingArea {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        .pagination {
            display: flex;
            list-style: none;
            padding: 0;
            gap: 10px;
        }

        .page-item {
            display: inline-block;
        }

        .page-item a {
            display: block;
            padding: 10px 15px;
            color: #718096;
            text-decoration: none;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .page-item.active a {
            background: #e4b6ec;
            color: white;
            border-color: #e4b6ec;
        }

        .page-item.disabled a {
            color: #cbd5e0;
            cursor: not-allowed;
            pointer-events: none;
        }

        .page-item:not(.disabled):not(.active) a:hover {
            background: #f3e8ff;
            border-color: #e4b6ec;
            color: #e4b6ec;
        }

        /* 로딩 스피너 */
        .loading-spinner {
            text-align: center;
            padding: 40px;
            grid-column: 1 / -1;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e4b6ec;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="breadcrumb">
        <a href="#">프로젝트 관리</a> > <span>전체 프로젝트 목록</span>
    </div>

    <div class="stats-bar">
        <div class="stat-item active" data-filter="all">
            <div class="stat-number" id="total-count">0</div>
            <div class="stat-label">전체 프로젝트</div>
        </div>
        <div class="stat-item" data-filter="active">
            <div class="stat-number" id="active-count">0</div>
            <div class="stat-label">진행중</div>
        </div>
        <div class="stat-item" data-filter="planning">
            <div class="stat-number" id="planning-count">0</div>
            <div class="stat-label">검토중</div>
        </div>
        <div class="stat-item" data-filter="expired">
            <div class="stat-number" id="expired-count">0</div>
            <div class="stat-label">만료</div>
        </div>
    </div>

    <input type="text" class="search-bar" id="searchInput" placeholder="검색할 프로젝트 제목을 입력하세요...">

    <div class="project-tabs">
        <div class="tab active" data-filter="all">전체 프로젝트 <span class="tab-count" id="tab-all-count">0</span></div>
        <div class="tab" data-filter="active">진행중인 프로젝트 <span class="tab-count" id="tab-active-count">0</span></div>
        <div class="tab" data-filter="planning">검토중인 프로젝트 <span class="tab-count" id="tab-planning-count">0</span></div>
        <div class="tab" data-filter="expired">지나간 프로젝트 <span class="tab-count" id="tab-expired-count">0</span></div>
    </div>

    <div class="project-grid" id="project-grid">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>프로젝트를 불러오는 중...</p>
        </div>
    </div>

    <div id="pagingArea">
        <ul class="pagination" id="pagination">
        </ul>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
    // 전체 프로젝트 데이터를 저장할 변수
    let allProjects = [];
    let filteredProjects = [];
    let currentFilter = 'all';
    let currentSearch = '';
    let currentPage = 1;
    const itemsPerPage = 9; // 한 페이지에 표시할 프로젝트 수

    // 페이지 로드 시 전체 데이터 가져오기
    $(document).ready(function() {
        // Thymeleaf에서 초기 데이터를 받아오거나 AJAX로 전체 데이터 로드
        loadAllProjects();
    });

    // 전체 프로젝트 데이터 로드 (AJAX 방식)
    function loadAllProjects() {
        // 방법 1: AJAX로 전체 데이터 가져오기
        $.ajax({
            url: '/project/getAllProjects', // 전체 프로젝트를 반환하는 엔드포인트
            type: 'GET',
            success: function(data) {
                allProjects = data;
                initializeProjects();
            },
            error: function() {
                // 방법 2: 현재 페이지의 데이터를 사용 (Thymeleaf 인라인)
                // 서버에서 전체 데이터를 미리 전달한 경우
                /*[# th:if="${allProjectList != null}"]*/
                allProjects = /*[[${allProjectList}]]*/ [];
                /*[/]*/

                if (allProjects.length === 0) {
                    // 데모 데이터 (실제로는 서버에서 가져와야 함)
                    console.log('전체 프로젝트 데이터를 로드할 수 없습니다.');
                }
                initializeProjects();
            }
        });
    }

    // 프로젝트 초기화
    function initializeProjects() {
        // 프로젝트 데이터 정규화 (상태 결정)
        allProjects = allProjects.map(project => {
            // 만료 여부 체크
            const endDate = new Date(project.pjtEndDate);
            const now = new Date();

            let status;
            if (now > endDate) {
                status = 'expired';
                project.statusText = '만료';
            } else if (project.pjtStatus === 'p') {
                status = 'active';
                project.statusText = '진행';
            } else if (project.pjtStatus === 'c') {
                status = 'planning';
                project.statusText = '검토';
            }

            project.statusKey = status;
            return project;
        });

        updateCounts();
        filterAndDisplay();
    }

    // 전체 카운트 업데이트
    function updateCounts() {
        const counts = {
            all: allProjects.length,
            active: 0,
            planning: 0,
            expired: 0
        };

        allProjects.forEach(project => {
            if (project.statusKey) {
                counts[project.statusKey]++;
            }
        });

        // 통계 바 업데이트
        $('#total-count').text(counts.all);
        $('#active-count').text(counts.active);
        $('#planning-count').text(counts.planning);
        $('#expired-count').text(counts.expired);

        // 탭 카운트 업데이트
        $('#tab-all-count').text(counts.all);
        $('#tab-active-count').text(counts.active);
        $('#tab-planning-count').text(counts.planning);
        $('#tab-expired-count').text(counts.expired);
    }

    // 필터링 및 표시
    function filterAndDisplay() {
        // 필터링
        filteredProjects = allProjects.filter(project => {
            const matchesFilter = currentFilter === 'all' || project.statusKey === currentFilter;

            const matchesSearch = currentSearch === '' ||
                (project.pjtName && project.pjtName.toLowerCase().includes(currentSearch)) ||
                (project.empName && project.empName.toLowerCase().includes(currentSearch));

            return matchesFilter && matchesSearch;
        });

        // 페이지 리셋
        currentPage = 1;

        // 표시
        displayProjects();
        updatePagination();
    }

    // 프로젝트 표시
    function displayProjects() {
        const startIdx = (currentPage - 1) * itemsPerPage;
        const endIdx = startIdx + itemsPerPage;
        const projectsToDisplay = filteredProjects.slice(startIdx, endIdx);

        const $grid = $('#project-grid');
        $grid.empty();

        if (projectsToDisplay.length === 0) {
            $grid.html(`
                <div class="no-projects">
                    <div>조건에 맞는 프로젝트가 없습니다.</div>
                </div>
            `);
            return;
        }

        projectsToDisplay.forEach(project => {
            const statusClass = getStatusClass(project.statusKey);
            const formattedDate = formatDate(project.pjtEnrollDate);

            const cardHtml = `
                <div class="project-card detailProject" data-pno="${project.pjtNo}">
                    <div class="project-header">
                        <input type="hidden" class="pno" value="${project.pjtNo}">
                        <h3 class="project-title">${project.pjtName}</h3>
                        <span class="project-status ${statusClass}">${project.statusText}</span>
                    </div>
                    <div class="project-info">
                        <div class="project-date">작성일: ${formattedDate}</div>
                        <div class="project-description">작성자: ${project.empName}</div>
                    </div>
                </div>
            `;

            $grid.append(cardHtml);
        });

        // 클릭 이벤트 재바인딩
        $('.detailProject').off('click').on('click', function() {
            const pno = $(this).data('pno');
            location.href = 'detail.pj?pno=' + pno;
        });
    }

    // 상태에 따른 클래스 반환
    function getStatusClass(statusKey) {
        const classMap = {
            'active': 'status-active',
            'planning': 'status-planning',
            'expired': 'status-expired'
        };
        return classMap[statusKey] || '';
    }

    // 날짜 포맷
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}년 ${month}월 ${day}일`;
    }

    // 페이지네이션 업데이트
    function updatePagination() {
        const totalPages = Math.ceil(filteredProjects.length / itemsPerPage);
        const $pagination = $('#pagination');
        $pagination.empty();

        if (totalPages <= 1) return;

        // 이전 버튼
        $pagination.append(`
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a href="#" data-page="${currentPage - 1}">◀ 이전</a>
            </li>
        `);

        // 페이지 번호
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            $pagination.append(`
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a href="#" data-page="${i}">${i}</a>
                </li>
            `);
        }

        // 다음 버튼
        $pagination.append(`
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a href="#" data-page="${currentPage + 1}">다음 ▶</a>
            </li>
        `);

        // 페이지 클릭 이벤트
        $('#pagination a').off('click').on('click', function(e) {
            e.preventDefault();
            const page = parseInt($(this).data('page'));
            if (!isNaN(page) && page !== currentPage && page > 0 && page <= totalPages) {
                currentPage = page;
                displayProjects();
                updatePagination();

                // 스크롤 상단으로
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    }

    // 탭 클릭 이벤트
    $('.tab').on('click', function() {
        $('.tab').removeClass('active');
        $('.stat-item').removeClass('active');

        $(this).addClass('active');
        currentFilter = $(this).data('filter');

        $(`.stat-item[data-filter="${currentFilter}"]`).addClass('active');

        filterAndDisplay();
    });

    // 통계 바 클릭 이벤트
    $('.stat-item').on('click', function() {
        const filter = $(this).data('filter');

        $('.tab').removeClass('active');
        $('.stat-item').removeClass('active');

        $(`.tab[data-filter="${filter}"]`).addClass('active');
        $(this).addClass('active');

        currentFilter = filter;
        filterAndDisplay();
    });

    // 검색 이벤트
    $('#searchInput').on('input', function() {
        currentSearch = $(this).val().toLowerCase();
        filterAndDisplay();
    });

    // 디바운싱 적용 (검색 성능 향상)
    let searchTimer;
    $('#searchInput').on('input', function() {
        clearTimeout(searchTimer);
        const searchValue = $(this).val().toLowerCase();

        searchTimer = setTimeout(function() {
            currentSearch = searchValue;
            filterAndDisplay();
        }, 300);
    });
</script>
</body>
</html>