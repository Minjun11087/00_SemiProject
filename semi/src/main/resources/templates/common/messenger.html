<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- jQuery 라이브러리 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- 부트스트랩에서 제공하고 있는 스타일 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- 부트스트랩에서 제공하고 있는 스크립트 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
    display: flex;
    height: 100vh;
    background: #f5f5f5;
}

/* 채팅방 목록 */
.chat-list {
    width: 300px;
    background: white;
    border-right: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
}

.chat-header {
    padding: 20px;
    background: #e4b6ec;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-title {
    font-size: 18px;
    font-weight: bold;
}

.header-icons {
    display: flex;
    gap: 15px;
}

.icon {
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.search-box {
    padding: 15px;
    background: #e4b6ec;
}

.search-input {
    width: 100%;
    padding: 10px 15px;
    border: none;
    border-radius: 20px;
    background: rgba(255,255,255,0.9);
    outline: none;
    font-size: 14px;
}

.search-clear {
    position: absolute;
    right: 30px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #999;
}

.search-container {
    position: relative;
}

.chat-rooms {
    flex: 1;
    overflow-y: auto;
}

.chat-room {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background-color 0.2s;
}

.chat-room:hover {
    background: #f8f8f8;
}

.chat-room.active {
    background: #e8f5e8;
}

.profile-img {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    font-size: 16px;
    font-weight: bold;
}

.chat-info {
    flex: 1;
}

.chat-name {
    font-weight: bold;
    margin-bottom: 3px;
    font-size: 15px;
}

.chat-preview {
    font-size: 13px;
    color: #666;
}

.chat-time {
    font-size: 11px;
    color: #999;
    margin-left: 10px;
}

/* 채팅 영역 */
.chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.chat-area-header {
    padding: 15px 20px;
    background: white;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.current-chat-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.current-chat-name {
    font-weight: bold;
    font-size: 16px;
}

.chat-members {
    font-size: 12px;
    color: #666;
}

.online-indicator {
    width: 8px;
    height: 8px;
    background: #4caf50;
    border-radius: 50%;
}

.messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #f8f8f8;
}

.message {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.message.my-message {
    justify-content: flex-end;
}

.message.my-message .message-bubble {
    background: #e4b6ec;
    color: white;
    order: 2;
}

.message.my-message .message-time {
    order: 1;
}

.message-bubble {
    background: white;
    padding: 10px 15px;
    border-radius: 20px;
    max-width: 70%;
    word-wrap: break-word;
    position: relative;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.message-time {
    font-size: 10px;
    color: #999;
    margin: 0 5px;
}

.input-area {
    padding: 15px 20px;
    background: white;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 10px;
    align-items: center;
}

.message-input {
    flex: 1;
    padding: 12px 20px;
    border: 1px solid #ddd;
    border-radius: 25px;
    outline: none;
    font-size: 14px;
    resize: none;
    max-height: 100px;
}

.message-input:focus {
    border-color: #e4b6ec;
}

.send-btn {
    width: 40px;
    height: 40px;
    background: #e4b6ec;
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

.send-btn:hover {
    background: #e4b6ec;
}

.send-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* 사이드바 */
.sidebar {
    width: 300px;
    background: white;
    border-left: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    background-color: #e4b6ec;
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
}

.sidebar-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.participant-count {
    font-size: 14px;
    color: #666;
}

.search-participants {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 15px;
    outline: none;
    font-size: 13px;
}

.participants-container {
    flex: 1;
    overflow-y: auto;
}

.participant:hover {
    cursor: pointer;
    background-color : lightgray;
}

.participants-section {
    padding: 15px 20px;
}

.section-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
    font-weight: bold;
}

.participant {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
}

.participant-profile {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    font-size: 14px;
    font-weight: bold;
}

.participant-name {
    flex: 1;
    font-size: 14px;
}

.online-status {
    width: 8px;
    height: 8px;
    background: #4caf50;
    border-radius: 50%;
}

.offline-status {
    width: 8px;
    height: 8px;
    background: #ccc;
    border-radius: 50%;
}

/* 모바일 반응형 */
@media (max-width: 768px) {
    .sidebar {
        display: none;
    }

    .chat-list {
        width: 100px;
    }

    .chat-name, .chat-preview {
        display: none;
    }

    .chat-room {
        justify-content: center;
    }
}

/* 스크롤바 스타일링 */
.chat-rooms::-webkit-scrollbar,
.messages-container::-webkit-scrollbar,
.participants-container::-webkit-scrollbar {
    width: 6px;
}

.chat-rooms::-webkit-scrollbar-track,
.messages-container::-webkit-scrollbar-track,
.participants-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.chat-rooms::-webkit-scrollbar-thumb,
.messages-container::-webkit-scrollbar-thumb,
.participants-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.chat-rooms::-webkit-scrollbar-thumb:hover,
.messages-container::-webkit-scrollbar-thumb:hover,
.participants-container::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}
</style>
</head>
<body>
    <div class="chat-list">
        <div class="chat-header">
            <span class="chat-title">채팅방</span>
            <div class="header-icons">
                <span class="icon">+</span>
                <span class="icon">⚙</span>
            </div>
        </div>

        <div class="search-box">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="채팅방 검색" id="chatSearch">
                <span class="search-clear" onclick="clearSearch()">×</span>
            </div>
        </div>

        <div class="chat-rooms" id="chatRoomsList">
            
        </div>
    </div>

    <!-- 채팅 영역 -->
    <div class="chat-area">
        <div class="chat-area-header">
            <div class="current-chat-info">
                <div>
                    <div class="current-chat-name" id="currentChatName"></div>
                    <div class="chat-members">대화상대 <span id="chatMemberCount">1</span>명</div>
                </div>
                <!-- 온라인 / 오프라인 조건넣기 -->
                <div class="online-indicator"></div>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="message" id="otherMessage">

            </div>

            <div class="message my-message" id="myMessage">

            </div>

        </div>

        <div class="input-area">
            <input type="text" class="message-input" placeholder="메시지를 입력하세요..." id="messageInput" name="msgContent">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- 사이드바 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <span>사원</span>
                <span class="participant-count" id="empCount">4</span>
            </div>
            <input type="text" class="search-participants" placeholder="사원 검색">
        </div>

        <div class="participants-container" id="participants-container">
            <div class="participants-section" id="participants-section">
                <div class="section-title">온라인 - <span id="onlineCount"></span></div>
                <div class="participantList" id="participantList">
                
                </div>
            </div>

            <div class="participants-section">
                <div class="section-title">오프라인 - <span id="offlineCount"></span></div>
                <div class="offlineList" id="offlineList">

                </div>
            </div>
        </div>
    </div>

    <th:block th:if="${session.loginUser != null}">
        <script th:inline="javascript">
            let myNo = [[${session.loginUser.empNo}]]
            let otherEmpNo = 0
        </script>
    </th:block>

    <script>
    $(function() {
        chatList();
        empList();
        wholeChatRoom();

        setInterval(chatList, 500);
        setInterval(empList, 500);
        setInterval(wholeChatRoom, 500);
    })

    function sendMessage() {
        $.ajax({
            url: "send.ms",
            data: {
                empRno: otherEmpNo,
                empSno: myNo,
                msgContent: $("#messageInput").val(),
            },
            type: "post",
            success: data => {
                if(data == 'success'){
                    const message = $.trim(data);
                    addMessage(message, true);
                    $("#messageInput").val('');
                    updateSendButton();
                }else{
                    console.log("메세지 실패");
                }
            },
            error: err => {
                console.error("메시지 전송 실패", err);
            }
        });
    }

    function chatList() {
        if(otherEmpNo === 0 || otherEmpNo === null) {
            console.log("채팅할 상대방이 선택되지 않았습니다.");
            $("#messagesContainer").html(""); // 메시지 컨테이너 비우기
            $("#currentChatName").html("채팅방"); // 채팅방 이름 초기화
            return;
        }

        $.ajax({
            url: "chatList.ms",
            data: {
                empSno: otherEmpNo,
                empRno: myNo,
            },
            type: "post",
            success: chatList => {
                let sendName = "";
                let allMessages = ""; // 모든 메시지를 순서대로 담을 변수

                // 시간순으로 정렬 (서버에서 이미 정렬되어 있다면 생략 가능)
                chatList.sort((a, b) => {
                    // msg_date가 문자열이면 Date로 변환하여 비교
                    return new Date(a.msgDate) - new Date(b.msgDate);
                });

                for(let i = 0; i < chatList.length; i++){
                    if(i === 0 || chatList[i].sendEmpName !== sendName) {
                        sendName = chatList[i].sendEmpName;
                    }

                    // 내가 보낸 메시지인지 확인
                    if(chatList[i].empSno == myNo) {
                        // 내 메시지 (오른쪽 정렬)
                        allMessages += "<div class='message my-message'>" +
                                          "<div class='message-time'>" + chatList[i].msgDate + "</div>" +
                                          "<div class='message-bubble'>" + chatList[i].msgContent + "</div>" +
                                       "</div>";
                    } else {
                        // 상대방 메시지 (왼쪽 정렬)
                        allMessages += "<div class='message'>" +
                                          "<div class='message-bubble'>" + chatList[i].msgContent + "</div>" +
                                          "<div class='message-time'>" + chatList[i].msgDate + "</div>" +
                                       "</div>";
                    }
                }

                // 채팅 상대방 이름 설정 (첫 번째 메시지의 상대방 이름)
                if(chatList.length > 0) {
                    // 상대방 이름 찾기
                    let otherName = "";
                    for(let i = 0; i < chatList.length; i++) {
                        if(chatList[i].empSno != myNo) {
                            otherName = chatList[i].sendEmpName;
                            break;
                        }
                    }
                    $("#currentChatName").html(otherName || "채팅방");
                }

                // 모든 메시지를 메시지 컨테이너에 추가
                $("#messagesContainer").html(allMessages);

                // 채팅창을 맨 아래로 스크롤
                $("#messagesContainer").scrollTop($("#messagesContainer")[0].scrollHeight);
            },
            error: err => {
                console.error("채팅 목록 불러오기 실패", err);
            }
        });
    }


    function empList() {
        $.ajax({
            url: "empList.ms",
            type: "get",
            success: function (empList) {
                let result1 = "";
                let result2 = "";
                let count1 = 0;
                let count2 = 0;
                let count3 = 0;


                for (let i = 0; i < empList.length; i++) {
                    if(empList[i].messengerStatus == 'Y') {
                        result1 += "<div class='participant' id='" + empList[i].empNo + "' onclick='selectEmpNo()'>" +
                                    "<div class='participant-profile'>" + empList[i].empName.substring(0, 1) + "</div>" +
                                    "<span class='participant-name'>" + empList[i].empName + "</span>" +
                                    "<div class='online-status'></div>" +
                                    "</div>";
                        if(empList[i].messengerStatus === 'Y') {
                            count1++;
                        }
                    }else {
                        result2 += "<div class='participant' id='" + empList[i].empNo + "' onclick='selectEmpNo()'>" +
                                    "<div class='participant-profile'>" + empList[i].empName.substring(0, 1) + "</div>" +
                                    "<span class='participant-name'>" + empList[i].empName + "</span>" +
                                    "<div class='offline-status'></div>" +
                                    "</div>";
                        if(empList[i].messengerStatus === 'N') {
                            count2++;
                        }
                    }
                    count3 = count1 + count2;
                }

                $("#participantList").html(result1);
                $("#offlineList").html(result2);
                $("#onlineCount").html(count1);
                $("#offlineCount").html(count2);
                $("#empCount").html(count3);
            },
            error: function () {
                console.log("참여자 목록 조회 실패");
            }
        });
    }

    function wholeChatRoom() {
        $.ajax({
            url : "wcr.ms",
            data : {
                empRno : myNo,
                empSno : myNo,
            },
            type : "post",
            success : wChatRoom => {
                let result = "";

                for(let i=0; i<wChatRoom.length; i++){
                    result += "<div class='chat-room active' data-room-id='i+1' data-room-name='" + wChatRoom[i].sendEmpName + " onclick='selectChatRoom()'>"
                           + "<div class'profile-img'>" + wChatRoom[i].sendEmpName.substring(0, 1) + "</div>"
                           + "<div class='chat-info'>"
                           + "<div class='chat-name'>" + wChatRoom[i].sendEmpName + "</div>"
                           + "<div class='chat-preview'>" + wChatRoom[i].msgContent + "</div>"
                           + "</div>"
                           + "<div class='chat-time'>" + wChatRoom[i].msgDate + "</div>"
                           + "</div>"
                }

                $("#chatRoomsList").html(result);
            }, error : wChatRoom => {

            },
        })
    }
    
    function selectChatRoom() {
        $.ajax({
            url : "cr.ms",
            data : {
                empRno: myNo,
                empSno: otherEmpNo,
            },
            type : "post",
            success : chatroom => {
                let result = "";
                let otherNo = chatroom[0].empSno;

                for(let i=0; i<chatroom.length; i++) {
                    if(otherEmpNo == otherNo){
                        result += "<div class='chat-room active' data-room-id='i+1' data-room-name='" + chatroom[i].sendEmpName + " onclick='selectEmpNo()'>"
                               + "<div class'profile-img'>" + chatroom[i].sendEmpName.substring(0, 1) + "</div>"
                               + "<div class='chat-info'>"
                               + "<div class='chat-name'>" + chatroom[i].sendEmpName + "</div>"
                               + "<div class='chat-preview'>" + chatroom[i].msgContent + "</div>"
                               + "</div>"
                               + "<div class='chat-time'>" + chatroom[i].msgDate + "</div>"
                               + "</div>"
                    }else{
                        result += "<div class='chat-room' data-room-id='i+1' data-room-name='" + chatroom[i].sendEmpName + " onclick='selectEmpNo()'>"
                               + "<div class'profile-img'>" + chatroom[i].sendEmpName.substring(0, 1) + "</div>"
                               + "<div class='chat-info'>"
                               + "<div class='chat-name'>" + chatroom[i].sendEmpName + "</div>"
                               + "<div class='chat-preview'>" + chatroom[i].msgContent + "</div>"
                               + "</div>"
                               + "<div class='chat-time'>" + chatroom[i].msgDate + "</div>"
                               + "</div>"
                    }
                }

                $("#chatRoomsList").html(result);

            }, error : chatroom => {
                console.log("대화방 목록 조회 실패");
            }
        })
    }

    function selectEmpNo() {
        // 온라인 사원 div 요소들에 클릭 이벤트 추가
        $("#participantList .participant").click(function() {
            const empNo = this.id; // div의 id가 사원번호

            if (empNo != null) {
                console.log('선택된 사원번호:', empNo);

                // 선택된 사원 강조 표시 (기존 선택 해제)
                $(".participant").removeClass('selected');
                $(this).addClass('selected');

                // 추가 작업 수행
                handleEmployeeSelection(empNo);
            }
        });

        // 오프라인 사원 div 요소들에 클릭 이벤트 추가
        $("#offlineList .participant").click(function() {
            const empNo = this.id; // div의 id가 사원번호

            if (empNo != null) {
                console.log('선택된 사원번호:', empNo);

                // 선택된 사원 강조 표시 (기존 선택 해제)
                $(".participant").removeClass('selected');
                $(this).addClass('selected');

                // 추가 작업 수행
                handleEmployeeSelection(empNo);
            }
        });
    }

        function handleEmployeeSelection(empNo) {
        // 선택된 사원번호를 otherEmpNo 변수에 저장
        otherEmpNo = empNo;
    }




    // 메시지 추가
    function addMessage(text, isMine) {
        const container = document.getElementById('messagesContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message' + (isMine ? ' my-message' : '');

        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const period = hours >= 12 ? '오후' : '오전';
        const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
        const timeStr = `${period} ${displayHours}:${minutes}`;

        messageDiv.innerHTML = isMine
            ? `<div class="message-time">${timeStr}</div><div class="message-bubble">${text}</div>`
            : `<div class="message-bubble">${text}</div><div class="message-time">${timeStr}</div>`;

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }

    // 전송 버튼 상태 업데이트
    function updateSendButton() {
        const input = document.getElementById('messageInput');
        const button = document.getElementById('sendBtn');
        button.disabled = input.value.trim() === '';
    }

    // 채팅방 검색
    function searchChatRooms() {
        const searchTerm = document.getElementById('chatSearch').value.toLowerCase();
        const chatRooms = document.querySelectorAll('.chat-room');

        chatRooms.forEach(room => {
            const chatName = room.querySelector('.chat-name').textContent.toLowerCase();
            room.style.display = chatName.includes(searchTerm) ? 'flex' : 'none';
        });
    }

    // 검색 초기화
    function clearSearch() {
        const searchInput = document.getElementById('chatSearch');
        searchInput.value = '';
        searchChatRooms();
    }

    // 채팅방 선택
    function selectChatRoom(roomElement) {
        // 이전 선택 해제
        document.querySelector('.chat-room.active')?.classList.remove('active');

        // 새로운 채팅방 선택
        roomElement.classList.add('active');

        // 채팅방 이름 업데이트
        const chatName = roomElement.dataset.roomName;
        document.getElementById('currentChatName').textContent = chatName;

        // 메시지 초기화
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = `
            <div class="message">
                <div class="message-bubble">${chatName}님과의 채팅을 시작합니다.</div>
                <div class="message-time">지금</div>
            </div>
        `;
    }

    // 이벤트 리스너 등록
    document.addEventListener('DOMContentLoaded', function () {
        // Enter 키로 메시지 전송
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 입력 상태에 따른 전송 버튼 활성화
        document.getElementById('messageInput').addEventListener('input', updateSendButton);

        // 채팅방 검색
        document.getElementById('chatSearch').addEventListener('input', searchChatRooms);

        // 채팅방 선택
        document.querySelectorAll('.chat-room').forEach(room => {
            room.addEventListener('click', function () {
                selectChatRoom(this);
            });
        });

        // 초기 전송 버튼 상태 설정
        updateSendButton();
    });

</script>

</body>
</html>