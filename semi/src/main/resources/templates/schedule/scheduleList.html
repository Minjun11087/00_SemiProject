<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleafe/layout"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스케줄 달력</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
          font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
          background-color: #f8f9fa;
          color: #333;
        }
        .main-container {
          display: flex;
          gap: 2rem;
          padding: 2rem;
          max-width: 1400px;
          margin: 0 auto;
          height : auto;
        }
        .calendar-section {
          flex: 1;
          background: white;
          border-radius: 20px;
          padding: 2rem;
          box-shadow: 0 10px 40px rgba(0,0,0,0.1);
          position: relative;
        }
        .calendar-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 2rem;
        }
        .calendar-nav { display: flex; align-items: center; gap: 1rem; }
        .nav-btn {
          width: 40px; height: 40px; border: none; border-radius: 50%;
          background: #f3f4f6; cursor: pointer; display: flex; align-items: center; justify-content: center;
          transition: all 0.3s ease; font-size: 1.2rem;
        }
        .nav-btn:hover { background: #e4b6ec; color: white; }
        .current-month { font-size: 1.5rem; font-weight: bold; color: #1f2937; }
        .calendar-container { position: relative; }
        .calendar-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 1.1px;
          background: #e5e7eb;
          border-radius: 10px;
          overflow: hidden;
        }
        .calendar-header-cell {
          background: #e4b6ec; color: white; text-align: center;
          padding: 1rem; font-weight: 600;
        }
        .calendar-cell {
          background: white; min-height: 150px; padding: 0.4rem;
          position: relative; transition: all 0.3s ease;
        }
        .calendar-cell:hover { background: #f8fafc; }
        .calendar-cell.other-month { color: #9ca3af; background: #f9fafb; }
        .calendar-cell.today { background: white; }
        .date-number {
          font-weight: bold;
          margin-bottom: 0.25rem;
          position: relative;
          z-index: 10;
          height: 15px;
          display: flex;
          align-items: center;
        }
        .today .date-number { color: #dc2626; font-weight: bold; }
        .schedule-overlay {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          pointer-events: none;
          z-index: 5;
        }
        .schedule-bar {
          position: absolute;
          height: 18px;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: flex-start;
          border-radius: 5px;
          overflow: hidden;
          z-index: 15;
          pointer-events: auto;
          font-size: 9px;
        }
        .schedule-bar:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 25;
        }
        .schedule-label {
          font-size: 0.7rem;
          color: white;
          font-weight: 600;
          text-shadow: 0 1px 2px rgba(0,0,0,0.7);
          white-space: nowrap;
          padding: 0 6px;
          overflow: hidden;
          text-overflow: ellipsis;
          width: 100%;
        }
        .sch-status-p { background: linear-gradient(135deg,#10B981 0%,#34D399 50%,#10B981 100%); }
        .sch-status-c { background: linear-gradient(135deg,#3B82F6 0%,#60A5FA 50%,#3B82F6 100%); }
        .sch-status-e { background: linear-gradient(135deg,#EF4444 0%,#F87171 50%,#EF4444 100%); }
        .sidebar { width: 280px; display: flex; flex-direction: column; gap: 1.5rem; }
        .schedule-details, .upcoming-schedules {
          background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .details-title { font-size: 1.125rem; font-weight: bold; margin-bottom: 1rem; color: #1f2937; }
        .detail-item { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .detail-label { font-size: 0.8rem; color: #6b7280; margin-bottom: 0.25rem; }
        .detail-value { font-weight: 600; color: #1f2937; }
        .status-badge {
          display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px;
          font-size: 0.75rem; font-weight: 600; color: white;
        }
        .status-badge.progressing { background: #10b981; }
        .status-badge.checking { background: #3B82F6; }
        .status-badge.expired { background: #ef4444; }
        .schedule-item {
          padding: 1rem; border-left: 4px solid #e4b6ec; background: #f8fafc;
          border-radius: 8px; margin-bottom: 1rem; transition: all 0.3s ease; cursor: pointer;
        }
        .schedule-item:hover { transform: translateX(4px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .schedule-time { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; }
        .schedule-title { font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
        .schedule-manager { font-size: 0.75rem; color: #6b7280; }
        .modal {
          display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
          background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
          background-color: white; margin: 5% auto; padding: 2rem; border-radius: 15px;
          width: 80%; max-width: 600px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;
        }
        .close {
          color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;
          position: absolute; right: 1rem; top: 1rem;
        }
        .close:hover { color: #000; }
        .modal-title { font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 1.5rem; padding-right: 2rem; }
        .modal-section { margin-bottom: 1.5rem; }
        .modal-section-title {
          font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;
          border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem;
        }
        .modal-detail { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .modal-detail-label { color: #6b7280; }
        .modal-detail-value { font-weight: 600; color: #1f2937; }
        @media (max-width: 1500px) {
          .main-container { flex-direction: column; }
          .sidebar { width: 100%; }
        }
    </style>
</head>
<body>
<main class="main-container">
    <section class="calendar-section">
        <div class="calendar-header">
            <div class="calendar-nav">
                <button class="nav-btn" onclick="previousMonth()">◀</button>
                <span class="current-month" id="currentMonth">2025년 8월</span>
                <button class="nav-btn" onclick="nextMonth()">▶</button>
            </div>
        </div>

        <div class="calendar-container">
            <div class="calendar-grid" id="calendarGrid">
                <div class="calendar-header-cell">일</div>
                <div class="calendar-header-cell">월</div>
                <div class="calendar-header-cell">화</div>
                <div class="calendar-header-cell">수</div>
                <div class="calendar-header-cell">목</div>
                <div class="calendar-header-cell">금</div>
                <div class="calendar-header-cell">토</div>
            </div>
            <div class="schedule-overlay" id="scheduleOverlay">
            </div>
        </div>

    </section>
    <aside class="sidebar">
        <div class="schedule-details">
            <h3 class="details-title">일정 상세 정보</h3>
            <div id="scheduleDetailContent">
                <p style="color: #6b7280; text-align: center; padding: 2rem;">일정을 선택하면 상세정보가 표시됩니다</p>
            </div>
        </div>
        <div class="upcoming-schedules">
            <h3 class="details-title">진행중인 일정</h3>
            <div id="upcomingSchedulesContainer"></div>
        </div>
    </aside>
</main>

<div id="scheduleModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 class="modal-title" id="modalTitle">일정 상세 보기</h2>
        <div class="modal-section">
            <h4 class="modal-section-title">일정 정보</h4>
            <div class="modal-detail">
                <span class="modal-detail-label">일정명:</span>
                <span class="modal-detail-value" id="modalSchName">-</span>
            </div>
            <div class="modal-detail">
                <span class="modal-detail-label">시작일:</span>
                <span class="modal-detail-value" id="modalSchStartDate">-</span>
            </div>
            <div class="modal-detail">
                <span class="modal-detail-label">종료일:</span>
                <span class="modal-detail-value" id="modalSchEndDate">-</span>
            </div>
            <div class="modal-detail">
                <span class="modal-detail-label">상태:</span>
                <span class="modal-detail-value" id="modalSchStatus">-</span>
            </div>
            <div class="modal-detail">
                <span class="modal-detail-label">조회수:</span>
                <span class="modal-detail-value" id="modalSchCount">-</span>
            </div>
            <div class="modal-detail">
                <span class="modal-detail-label">작성자:</span>
                <span class="modal-detail-value" id="modalEmpName">-</span>
            </div>
        </div>
        <div class="modal-section">
            <h4 class="modal-section-title">일정 설명</h4>
            <p id="modalSchContent" style="color: #374151; line-height: 1.6;">-</p>
        </div>
        <div class="modal-section">
            <h4 class="modal-section-title">일정 관리</h4>
            <div class="modal-detail">
                <span class="modal-detail-label">작성일:</span>
                <span class="modal-detail-value" id="modalSchEnrollDate">-</span>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const allSchedules = /*[[${plist}]]*/ [];
    let currentDate = new Date();
    let calendarGrid = null;

    const allSchedulesObj = {};
    allSchedules.forEach(schedule => {
        allSchedulesObj[`schedule${schedule.schNo}`] = schedule;
    });

    // 일정 상태 반환 함수 (텍스트, 클래스)
    function getScheduleStatus(schedule) {
        const endDate = new Date(schedule.schEndDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (endDate < today) {
            return { text: '만료', class: 'expired' };
        } else {
            switch (schedule.schStatus) {
                case 'p': return { text: '진행', class: 'progressing' };
                case 'c': return { text: '검토', class: 'checking' };
                default: return { text: '검토', class: 'checking' };
            }
        }
    }

    // 일정바 색상을 위한 상태 반환 함수
    function getScheduleColorStatus(schedule) {
        const endDate = new Date(schedule.schEndDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (endDate < today) {
            return 'e'; // 만료 상태
        } else {
            // 상태값 정리 (공백 제거, 소문자 변환)
            const status = String(schedule.schStatus).toLowerCase();
            return status; // 원래 상태 사용
        }
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('ko-KR');
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('currentMonth').textContent = `${year}년 ${month + 1}월`;
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        const startDate = new Date(firstDay);
        startDate.setDate(firstDay.getDate() - firstDay.getDay());

        const grid = document.getElementById('calendarGrid');
        const existingCells = grid.querySelectorAll('.calendar-cell');
        existingCells.forEach(cell => cell.remove());

        const weeksNeeded = getWeeksNeeded(year, month);
        const totalCells = weeksNeeded * 7;
        const cells = [];

        for (let i = 0; i < totalCells; i++) {
            const cellDate = new Date(startDate);
            cellDate.setDate(startDate.getDate() + i);

            const cellElement = document.createElement('div');
            cellElement.className = 'calendar-cell';
            cellElement.dataset.cellIndex = i;

            if (cellDate.getMonth() !== month) {
                cellElement.classList.add('other-month');
            }

            const today = new Date();
            if (cellDate.toDateString() === today.toDateString()) {
                cellElement.classList.add('today');
            }

            cellElement.innerHTML = `<div class="date-number">${cellDate.getDate()}</div>`;
            grid.appendChild(cellElement);

            cells.push({
                element: cellElement,
                date: new Date(cellDate)
            });
        }
        calendarGrid = grid;
        renderSchedules(cells, startDate, year, month);
    }

    function getWeeksNeeded(year, month) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startOfFirstWeek = new Date(firstDay);
        startOfFirstWeek.setDate(firstDay.getDate() - firstDay.getDay());
        const endOfLastWeek = new Date(lastDay);
        endOfLastWeek.setDate(lastDay.getDate() + (6 - lastDay.getDay()));
        const diffTime = endOfLastWeek.getTime() - startOfFirstWeek.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return Math.ceil(diffDays / 7);
    }

    function renderSchedules(cells, startDate, currentYear, currentMonth) {
        const scheduleOverlay = document.getElementById('scheduleOverlay');
        scheduleOverlay.innerHTML = '';
        const cellScheduleRows = cells.map(() => []);
        const monthStart = new Date(currentYear, currentMonth, 1);
        const monthEnd = new Date(currentYear, currentMonth + 1, 0);
        Object.entries(allSchedulesObj).forEach(([scheduleId, schedule]) => {
            const scheduleStart = new Date(schedule.schStartDate);
            const scheduleEnd = new Date(schedule.schEndDate);
            if (scheduleEnd >= monthStart && scheduleStart <= monthEnd) {
                createMultiRowScheduleBars(cells, scheduleId, schedule, scheduleStart, scheduleEnd, startDate, cellScheduleRows, currentMonth);
            }
        });
    }

    function createMultiRowScheduleBars(cells, scheduleId, schedule, scheduleStart, scheduleEnd, calendarStartDate, cellScheduleRows, currentMonth) {
        const calendarEndDate = new Date(calendarStartDate.getTime() + (cells.length - 1) * 24 * 60 * 60 * 1000);
        const actualStart = scheduleStart < calendarStartDate ? calendarStartDate : scheduleStart;
        const actualEnd = scheduleEnd > calendarEndDate ? calendarEndDate : scheduleEnd;
        const startCellIndex = Math.floor((actualStart - calendarStartDate) / (1000 * 60 * 60 * 24));
        const endCellIndex = Math.floor((actualEnd - calendarStartDate) / (1000 * 60 * 60 * 24));
        let currentMonthStartIndex = -1;
        let currentMonthEndIndex = -1;
        for (let i = startCellIndex; i <= endCellIndex && i < cells.length; i++) {
            if (!cells[i].element.classList.contains('other-month')) {
                if (currentMonthStartIndex === -1) {
                    currentMonthStartIndex = i;
                }
                currentMonthEndIndex = i;
            }
        }
        if (currentMonthStartIndex === -1) {
            return;
        }
        let currentIndex = currentMonthStartIndex;
        while (currentIndex <= currentMonthEndIndex) {
            const currentRow = Math.floor(currentIndex / 7);
            const rowStart = currentRow * 7;
            const rowEnd = Math.min(rowStart + 6, currentMonthEndIndex);
            let weekStart = Math.max(currentIndex, rowStart);
            let weekEnd = Math.min(currentMonthEndIndex, rowEnd);
            while (weekStart <= weekEnd && cells[weekStart].element.classList.contains('other-month')) {
                weekStart++;
            }
            while (weekEnd >= weekStart && cells[weekEnd].element.classList.contains('other-month')) {
                weekEnd--;
            }
            if (weekStart > weekEnd) {
                currentIndex = rowEnd + 1;
                continue;
            }
            let assignedRow = 0;
            while (true) {
                let canUseRow = true;
                for (let cellIndex = weekStart; cellIndex <= weekEnd; cellIndex++) {
                    if (cellScheduleRows[cellIndex][assignedRow]) {
                        canUseRow = false;
                        break;
                    }
                }
                if (canUseRow) break;
                assignedRow++;
            }
            for (let cellIndex = weekStart; cellIndex <= weekEnd; cellIndex++) {
                if (!cells[cellIndex].element.classList.contains('other-month')) {
                    cellScheduleRows[cellIndex][assignedRow] = scheduleId;
                }
            }
            createScheduleBar(cells, scheduleId, schedule, weekStart, weekEnd, assignedRow);
            currentIndex = rowEnd + 1;
        }
    }

    function createScheduleBar(cells, scheduleId, schedule, startIndex, endIndex, row) {
        const startCell = cells[startIndex];
        const endCell = cells[endIndex];
        let actualStartIndex = startIndex;
        let actualEndIndex = endIndex;
        while (actualStartIndex <= endIndex && cells[actualStartIndex].element.classList.contains('other-month')) {
            actualStartIndex++;
        }
        while (actualEndIndex >= startIndex && cells[actualEndIndex].element.classList.contains('other-month')) {
            actualEndIndex--;
        }
        if (actualStartIndex > actualEndIndex) {
            return;
        }
        const actualStartCell = cells[actualStartIndex];
        const actualEndCell = cells[actualEndIndex];
        const startCellRect = actualStartCell.element.getBoundingClientRect();
        const endCellRect = actualEndCell.element.getBoundingClientRect();
        const containerRect = calendarGrid.parentElement.getBoundingClientRect();
        const left = startCellRect.left - containerRect.left;
        const width = endCellRect.right - startCellRect.left;
        const headerHeight = 57;
        const cellTopOffset = 25;
        const rowHeight = 20;
        const currentCellHeight = actualStartCell.element.offsetHeight;
        const newCellHeight = currentCellHeight || 150;
        const weekRowIndex = Math.floor(actualStartIndex / 7);
        const top = headerHeight + (weekRowIndex * (newCellHeight + 1)) + cellTopOffset + (row * rowHeight);

        // 동적 상태 적용
        const colorStatus = getScheduleColorStatus(schedule);

        const bar = document.createElement('div');
        bar.className = `schedule-bar sch-status-${colorStatus}`;
        bar.style.left = `${left + 4}px`;
        bar.style.top = `${top}px`;
        bar.style.width = `${width - 8}px`;
        bar.style.height = '18px';
        bar.style.display = 'flex';
        bar.style.alignItems = 'center';
        bar.style.justifyContent = 'center';
        bar.style.textAlign = 'center';
        const displayText = schedule.schName;
        bar.innerHTML = `<span class="schedule-label">${displayText}</span>`;
        bar.onclick = (e) => {
            e.stopPropagation();
            showScheduleDetail(scheduleId);
        };
        bar.title = `${schedule.schName} (${schedule.schStartDate} ~ ${schedule.schEndDate})`;
        document.getElementById('scheduleOverlay').appendChild(bar);
    }

    function showScheduleDetail(scheduleId) {
        if (!allSchedulesObj[scheduleId]) return;
        const schedule = allSchedulesObj[scheduleId];


        const status = getScheduleStatus(schedule);
        const detailContent = document.getElementById('scheduleDetailContent');
        detailContent.innerHTML = `
            <div class="detail-item">
                <div class="detail-label">일정명</div>
                <div class="detail-value">${schedule.schName}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">작성자</div>
                <div class="detail-value">${schedule.empName}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">시작일</div>
                <div class="detail-value">${schedule.schStartDate}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">종료일</div>
                <div class="detail-value">${schedule.schEndDate}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">상태</div>
                <div class="detail-value">
                    <span class="status-badge ${status.class}">
                        ${status.text}
                    </span>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">조회수</div>
                <div class="detail-value">${schedule.schCount}</div>
            </div>
        `;
        openModal(scheduleId);
    }

    function openModal(scheduleId) {
        const schedule = allSchedulesObj[scheduleId];
        if (!schedule) return;
        const status = getScheduleStatus(schedule);
        document.getElementById('modalTitle').textContent = schedule.schName;
        document.getElementById('modalSchName').textContent = schedule.schName;
        document.getElementById('modalSchStartDate').textContent = schedule.schStartDate;
        document.getElementById('modalSchEndDate').textContent = schedule.schEndDate;
        document.getElementById('modalSchCount').textContent = schedule.schCount;


        document.getElementById('modalSchStatus').innerHTML = `
            <span class="status-badge ${status.class}">
                ${status.text}
            </span><br>
        `;
        document.getElementById('modalEmpName').textContent = schedule.empName;
        document.getElementById('modalSchContent').textContent = schedule.schContent;
        document.getElementById('modalSchEnrollDate').textContent = formatDate(schedule.schEnrollDate);
        document.getElementById('scheduleModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('scheduleModal').style.display = 'none';
    }

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }

function renderUpcomingSchedules() {
    const container = document.getElementById('upcomingSchedulesContainer');
    container.innerHTML = '';

    // schStatus가 'p'인 일정만 필터링
    Object.entries(allSchedulesObj).forEach(([scheduleId, schedule]) => {
        if (schedule.schStatus === 'p') {
            const scheduleItem = document.createElement('div');
            scheduleItem.className = 'schedule-item';
            scheduleItem.onclick = () => showScheduleDetail(scheduleId);
            scheduleItem.innerHTML = `
                <div class="schedule-time">${schedule.schStartDate} - ${schedule.schEndDate}</div>
                <div class="schedule-title">${schedule.schName}</div>
                <div class="schedule-manager">작성자: ${schedule.empName}</div>
            `;
            container.appendChild(scheduleItem);
        }
    });
}

    window.onclick = function(event) {
        const modal = document.getElementById('scheduleModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    window.addEventListener('resize', () => {
        setTimeout(renderCalendar, 100);
    });

    document.addEventListener('DOMContentLoaded', function() {
        renderCalendar();
        renderUpcomingSchedules();
    });
</script>
</body>
</html>